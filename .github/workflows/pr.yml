# PR workflow - runs tests on pull requests
name: PR Build

on:
  pull_request:
    branches:
      - master
      - main

jobs:
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run unit tests
        run: make test-unit

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: out/coverage/
          retention-days: 7

  # NOTE: Docker build and push steps are commented out due to org package permissions.
  # Uncomment this job when you have permission to push to ghcr.io
  #
  # build-preview:
  #   name: Build Preview Image
  #   runs-on: ubuntu-latest
  #   needs: test
  #   permissions:
  #     contents: read
  #     packages: write
  #     pull-requests: write
  #   env:
  #     REGISTRY: ghcr.io
  #     IMAGE_NAME: ${{ github.repository }}
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Set up QEMU
  #       uses: docker/setup-qemu-action@v3
  #
  #     - name: Set up Docker Buildx
  #       uses: docker/setup-buildx-action@v3
  #
  #     - name: Log in to GitHub Container Registry
  #       uses: docker/login-action@v3
  #       with:
  #         registry: ${{ env.REGISTRY }}
  #         username: ${{ github.actor }}
  #         password: ${{ secrets.GITHUB_TOKEN }}
  #
  #     - name: Build and push PR preview image
  #       uses: docker/build-push-action@v5
  #       with:
  #         context: .
  #         file: docker/Dockerfile
  #         target: butler
  #         platforms: linux/amd64
  #         push: true
  #         tags: |
  #           ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:pr-${{ github.event.number }}
  #           ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ github.event.pull_request.head.sha }}
  #         build-args: |
  #           VERSION=pr-${{ github.event.number }}
  #         cache-from: type=gha
  #         cache-to: type=gha,mode=max
  #
  #     - name: Comment PR with image info
  #       uses: actions/github-script@v7
  #       with:
  #         script: |
  #           const image = `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:pr-${{ github.event.number }}`;
  #           const body = `## ðŸ³ Docker Image Preview
  #           
  #           A preview image has been built and pushed for this PR:
  #           
  #           \`\`\`bash
  #           docker pull ${image}
  #           \`\`\`
  #           
  #           **Tags:**
  #           - \`pr-${{ github.event.number }}\` - PR number tag
  #           - \`sha-${{ github.event.pull_request.head.sha }}\` - Commit SHA tag
  #           
  #           **Note:** PR preview images are automatically cleaned up after the PR is merged or closed.`;
  #           
  #           const { data: comments } = await github.rest.issues.listComments({
  #             owner: context.repo.owner,
  #             repo: context.repo.repo,
  #             issue_number: context.issue.number,
  #           });
  #           
  #           const botComment = comments.find(comment => 
  #             comment.user.type === 'Bot' && 
  #             comment.body.includes('Docker Image Preview')
  #           );
  #           
  #           if (botComment) {
  #             await github.rest.issues.updateComment({
  #               owner: context.repo.owner,
  #               repo: context.repo.repo,
  #               comment_id: botComment.id,
  #               body: body
  #             });
  #           } else {
  #             await github.rest.issues.createComment({
  #               owner: context.repo.owner,
  #               repo: context.repo.repo,
  #               issue_number: context.issue.number,
  #               body: body
  #             });
  #           }
